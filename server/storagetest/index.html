// HTML 파일
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resumable Upload Supabase + UppyJS</title>
  <link href="https://releases.transloadit.com/uppy/v3.6.1/uppy.min.css" rel="stylesheet" />
  <!-- CSS 및 기타 스타일들 -->
</head>
<body>
  <!-- HTML 본문 -->
  <img id="logo" src="supabase-logo-wordmark--dark.png" />
  <div id="drag-drop-area"></div>
  <a href="https://supabase.com/docs/guides/storage/uploads/resumable-uploads" target="_blank">
    Read the docs.
  </a>

  <script type="module">
    import { Uppy, Dashboard, Tus } from 'https://releases.transloadit.com/uppy/v3.6.1/uppy.min.mjs'

    // 서버에서 환경 변수 가져오기
    fetch('/config')
      .then(response => response.json())
      .then(config => {
        const { SUPABASE_ANON_KEY, SUPABASE_PROJECT_ID, STORAGE_BUCKET, BEARER_TOKEN } = config;

        // Uppy 초기화 및 설정
        const folder = ''
        const supabaseStorageURL = `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/upload/resumable`

        var uppy = new Uppy()
          .use(Dashboard, {
            inline: true,
            limit: 10,
            target: '#drag-drop-area',
            showProgressDetails: true,
          })
          .use(Tus, {
            endpoint: supabaseStorageURL,
            headers: {
              authorization: `Bearer ${BEARER_TOKEN}`,
              apikey: SUPABASE_ANON_KEY,
            },
            uploadDataDuringCreation: true,
            chunkSize: 6 * 1024 * 1024,
            allowedMetaFields: ['bucketName', 'objectName', 'contentType', 'cacheControl'],
            onError: function (error) {
              console.log('Failed because: ' + error)
            },
          })

        uppy.on('file-added', (file) => {
          const supabaseMetadata = {
            bucketName: STORAGE_BUCKET,
            objectName: folder ? `${folder}/${file.name}` : file.name,
            contentType: file.type,
          }

          file.meta = {
            ...file.meta,
            ...supabaseMetadata,
          }
          console.log('file added', file)
        })

        uppy.on('complete', (result) => {
          console.log('Upload complete! We’ve uploaded these files:', result.successful)
        })
      })
      .catch(error => {
        console.error('Error fetching config:', error);
      });
  </script>
</body>
</html>
